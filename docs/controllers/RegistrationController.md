# üìù RegistrationController

**Controlador para la gesti√≥n de inscripciones de usuarios**

---

## üìã Informaci√≥n General

| Atributo | Valor |
|----------|-------|
| **Namespace** | `App\Http\Controllers` |
| **Ruta del archivo** | `app/Http/Controllers/RegistrationController.php` |
| **Tipo** | Controlador Autenticado |
| **Autenticaci√≥n** | Requerida |

---

## üéØ Prop√≥sito

El `RegistrationController` gestiona todas las operaciones relacionadas con las inscripciones de usuarios a torneos. Permite a los usuarios autenticados ver sus inscripciones, crear nuevas inscripciones, y gestionar el estado de sus participaciones en torneos.

---

## üõ†Ô∏è M√©todos del Controlador

### üìã `index()`
**Listado de inscripciones del usuario**

```mermaid
graph LR
    A[üîê Usuario Autenticado] --> B[registrations/]
    B --> C[RegistrationController@index]
    C --> D[Obtener inscripciones del usuario]
    D --> E[Cargar torneos y juegos]
    E --> F[üìã Mis Inscripciones]
```

**Funcionalidad:**
- Lista todas las inscripciones del usuario autenticado
- Incluye informaci√≥n del torneo y juego relacionado
- Muestra el estado de cada inscripci√≥n
- Ordenadas por fecha de torneo

**C√≥digo:**
```php
public function index()
{
    $registrations = Registration::where('user_id', auth()->id())
        ->with(['tournament.game'])
        ->orderBy('created_at', 'desc')
        ->get();

    return Inertia::render('Registrations/Index', [
        'registrations' => $registrations
    ]);
}
```

### üíæ `store(StoreRegistrationRequest $request)`
**Crear nueva inscripci√≥n**

```mermaid
graph LR
    A[üîê Usuario] --> B[POST registrations/]
    B --> C[StoreRegistrationRequest]
    C --> D[Validar datos]
    D --> E[Verificar disponibilidad]
    E --> F[Crear inscripci√≥n]
    F --> G[‚úÖ Inscripci√≥n Exitosa]
    
    D --> H[‚ùå Error de Validaci√≥n]
    E --> I[‚ùå Torneo Lleno]
```

**Funcionalidad:**
- Valida los datos de inscripci√≥n mediante `StoreRegistrationRequest`
- Verifica que el torneo tenga cupos disponibles
- Previene inscripciones duplicadas
- Crea la inscripci√≥n con estado 'pending'

**C√≥digo:**
```php
public function store(StoreRegistrationRequest $request)
{
    $tournament = Tournament::findOrFail($request->tournament_id);
    
    // Verificar si el torneo est√° lleno
    if ($tournament->registrations()->count() >= $tournament->max_participants) {
        return back()->with('error', 'El torneo est√° lleno');
    }
    
    // Verificar si ya est√° inscrito
    if ($tournament->registrations()->where('user_id', auth()->id())->exists()) {
        return back()->with('error', 'Ya est√°s inscrito en este torneo');
    }
    
    Registration::create([
        'user_id' => auth()->id(),
        'tournament_id' => $request->tournament_id,
        'status' => 'pending'
    ]);
    
    return redirect()->route('registrations.index')
        ->with('success', 'Inscripci√≥n realizada exitosamente');
}
```

### üóëÔ∏è `destroy(Registration $registration)`
**Cancelar inscripci√≥n**

```mermaid
graph LR
    A[üîê Usuario] --> B[DELETE registrations/{id}]
    B --> C[Verificar propiedad]
    C --> D[Verificar plazo]
    D --> E[Eliminar inscripci√≥n]
    E --> F[‚úÖ Cancelaci√≥n Exitosa]
    
    C --> G[‚ùå No Autorizado]
    D --> H[‚ùå Plazo Vencido]
```

**Funcionalidad:**
- Verifica que el usuario sea propietario de la inscripci√≥n
- Valida que est√© dentro del plazo de cancelaci√≥n
- Elimina la inscripci√≥n de la base de datos
- Libera el cupo para otros usuarios

**C√≥digo:**
```php
public function destroy(Registration $registration)
{
    // Verificar que el usuario sea el propietario
    if ($registration->user_id !== auth()->id()) {
        abort(403, 'No autorizado');
    }
    
    // Verificar plazo de cancelaci√≥n
    if ($registration->tournament->registration_deadline < now()) {
        return back()->with('error', 'No puedes cancelar despu√©s del plazo l√≠mite');
    }
    
    $registration->delete();
    
    return redirect()->route('registrations.index')
        ->with('success', 'Inscripci√≥n cancelada exitosamente');
}
```

---

## üîÑ Flujo de Inscripci√≥n

```mermaid
graph TD
    A[üîç Usuario ve torneo] --> B[Clic en Inscribirse]
    B --> C{¬øEst√° autenticado?}
    C -->|No| D[üîê Ir a Login]
    C -->|S√≠| E[Formulario de Inscripci√≥n]
    
    D --> F[Login exitoso]
    F --> E
    
    E --> G[Enviar formulario]
    G --> H[Validar datos]
    H --> I{¬øDatos v√°lidos?}
    I -->|No| J[‚ùå Mostrar errores]
    I -->|S√≠| K[Verificar disponibilidad]
    
    K --> L{¬øHay cupos?}
    L -->|No| M[‚ùå Torneo lleno]
    L -->|S√≠| N[Verificar inscripci√≥n duplicada]
    
    N --> O{¬øYa inscrito?}
    O -->|S√≠| P[‚ùå Ya inscrito]
    O -->|No| Q[Crear inscripci√≥n]
    
    Q --> R[‚úÖ Inscripci√≥n exitosa]
    R --> S[üìã Ver mis inscripciones]
    
    J --> E
    M --> E
    P --> E
```

---

## üé® Vistas Relacionadas

| Vista | Descripci√≥n | Ruta |
|-------|-------------|------|
| **Registrations/Index** | Lista de inscripciones del usuario | `resources/js/pages/Registrations/Index.tsx` |

---

## üìä Estados de Inscripci√≥n

```mermaid
graph LR
    A[üìù Pending] --> B[üí∞ Payment Required]
    B --> C[‚úÖ Confirmed]
    
    A --> D[‚ùå Cancelled]
    B --> D
    
    style A fill:#fff3e0
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#ffcdd2
```

| Estado | Descripci√≥n | Color |
|--------|-------------|-------|
| **pending** | Inscripci√≥n creada, esperando pago | üü° Amarillo |
| **payment_required** | Pago requerido para confirmar | üîµ Azul |
| **confirmed** | Inscripci√≥n confirmada | üü¢ Verde |
| **cancelled** | Inscripci√≥n cancelada | üî¥ Rojo |

---

## üîó Relaciones con Otros Componentes

```mermaid
graph TB
    A[RegistrationController] --> B[Registration Model]
    A --> C[Tournament Model]
    A --> D[User Model]
    A --> E[Game Model]
    A --> F[StoreRegistrationRequest]
    A --> G[Registrations/Index View]
    
    B --> H[belongsTo Tournament]
    H --> C
    
    B --> I[belongsTo User]
    I --> D
    
    C --> J[belongsTo Game]
    J --> E
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#f3e5f5
    style D fill:#f3e5f5
    style E fill:#f3e5f5
    style F fill:#fff3e0
    style G fill:#e8f5e8
```

---

## üõ£Ô∏è Rutas Asociadas

| M√©todo | Ruta | Nombre | Descripci√≥n |
|--------|------|--------|-------------|
| **GET** | `/registrations` | `registrations.index` | Lista de inscripciones |
| **POST** | `/registrations` | `registrations.store` | Crear inscripci√≥n |
| **DELETE** | `/registrations/{registration}` | `registrations.destroy` | Cancelar inscripci√≥n |

---

## üîí Validaciones y Seguridad

### üìù StoreRegistrationRequest
```php
public function rules()
{
    return [
        'tournament_id' => ['required', 'exists:tournaments,id'],
    ];
}
```

### üõ°Ô∏è Verificaciones de Seguridad
1. **Autenticaci√≥n requerida**: Solo usuarios autenticados pueden inscribirse
2. **Propiedad de inscripci√≥n**: Solo el propietario puede cancelar su inscripci√≥n
3. **Verificaci√≥n de cupos**: Previene inscripciones cuando el torneo est√° lleno
4. **Prevenci√≥n de duplicados**: Un usuario no puede inscribirse dos veces al mismo torneo
5. **Plazo de cancelaci√≥n**: Respeta los plazos l√≠mite de cancelaci√≥n

---

## üìä Datos Utilizados

### üìù Registration Model
- **id**: Identificador √∫nico
- **user_id**: ID del usuario inscrito
- **tournament_id**: ID del torneo
- **status**: Estado de la inscripci√≥n
- **payment_status**: Estado del pago
- **payment_confirmed_at**: Fecha de confirmaci√≥n de pago
- **created_at**: Fecha de inscripci√≥n

### üèÜ Tournament Model (relacionado)
- **name**: Nombre del torneo
- **tournament_date**: Fecha del torneo
- **registration_deadline**: Fecha l√≠mite de inscripci√≥n
- **max_participants**: M√°ximo de participantes
- **entry_fee**: Costo de inscripci√≥n

### üéÆ Game Model (relacionado)
- **name**: Nombre del juego
- **image**: Imagen del juego

---

## üéØ Caracter√≠sticas Especiales

### üîÑ Optimizaci√≥n de Consultas
```php
// Eager loading para evitar consultas N+1
$registrations = Registration::where('user_id', auth()->id())
    ->with(['tournament.game'])
    ->orderBy('created_at', 'desc')
    ->get();
```

### üö´ Prevenci√≥n de Duplicados
```php
// Verificaci√≥n a nivel de aplicaci√≥n
if ($tournament->registrations()->where('user_id', auth()->id())->exists()) {
    return back()->with('error', 'Ya est√°s inscrito en este torneo');
}
```

### üìÖ Verificaci√≥n de Plazos
```php
// Verificaci√≥n del plazo de cancelaci√≥n
if ($registration->tournament->registration_deadline < now()) {
    return back()->with('error', 'No puedes cancelar despu√©s del plazo l√≠mite');
}
```

---

## üí° Consideraciones de UX

> **üîç Transparencia**: El usuario ve claramente el estado de todas sus inscripciones.

> **‚ö° Feedback Inmediato**: Mensajes claros de √©xito y error en cada acci√≥n.

> **üõ°Ô∏è Validaciones Claras**: Mensajes de error espec√≠ficos para cada caso.

> **üì± Experiencia Mobile**: Dise√±o responsive para acceso desde cualquier dispositivo.

---

## üîó Interacciones con Otros Controladores

```mermaid
graph TB
    A[TournamentController] --> B[Mostrar bot√≥n Inscribirse]
    B --> C[RegistrationController@store]
    
    D[AdminController] --> E[Gestionar Inscripciones]
    E --> F[Ver todas las inscripciones]
    F --> G[Confirmar pagos]
    
    H[RegistrationController] --> I[Mis Inscripciones]
    I --> J[Cancelar inscripciones]
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#ffcdd2
    style H fill:#fff3e0
```

---

## üìù Notas Importantes

> **üí° Tip**: Las inscripciones se crean con estado 'pending' y requieren confirmaci√≥n de pago.

> **üîç Seguridad**: M√∫ltiples capas de validaci√≥n para prevenir inscripciones inv√°lidas.

> **‚è∞ Plazos**: Respeta los plazos de inscripci√≥n y cancelaci√≥n establecidos en cada torneo.

> **üéØ Experiencia**: Flujo simple y directo para facilitar las inscripciones.

---

## üîó Enlaces Relacionados

- [[AdminController]] - Gesti√≥n administrativa de inscripciones
- [[TournamentController]] - Visualizaci√≥n de torneos
- [[StoreRegistrationRequest]] - Validaciones de inscripci√≥n
- [[Registration Model]] - Modelo de datos de inscripciones
- [[Rutas Autenticadas]] - Rutas que requieren login
